<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIDLEX.AE • Admin Analytics</title>
  <meta name="color-scheme" content="dark">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .card { background: linear-gradient(180deg, rgba(15,23,42,0.9), rgba(15,23,42,0.65)); border: 1px solid rgba(148,163,184,0.12); border-radius: 18px; }
    .card-soft { background: rgba(15,23,42,0.6); border: 1px solid rgba(71,85,105,0.35); border-radius: 16px; }
    canvas { max-width: 100%; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-7xl mx-auto px-4 py-10 space-y-10">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">AIDLEX.AE • Admin Analytics</h1>
        <p class="text-slate-400 text-sm">Live operational metrics for request load, token spend, SSE latency, and KB cache performance.</p>
      </div>
      <div class="flex items-center gap-3 text-sm text-slate-400">
        <a href="/" class="text-sky-400 hover:text-sky-300 transition">← Back to app</a>
        <span>|</span>
        <span>Last updated: <span id="last-updated" class="text-slate-200">--</span></span>
      </div>
    </header>

    <p id="status" class="text-sm text-amber-400"></p>

    <section class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <div class="card p-5 shadow-lg">
        <h2 class="text-xs uppercase tracking-wide text-slate-400">Total Requests</h2>
        <p id="totalRequests" class="text-3xl font-semibold mt-2">--</p>
        <p class="text-xs text-slate-500 mt-1">Cumulative across all API routes.</p>
      </div>
      <div class="card p-5 shadow-lg">
        <h2 class="text-xs uppercase tracking-wide text-slate-400">Prompt Tokens</h2>
        <p id="promptTokens" class="text-3xl font-semibold mt-2">--</p>
        <p class="text-xs text-slate-500 mt-1">Tokens sent to chat endpoints.</p>
      </div>
      <div class="card p-5 shadow-lg">
        <h2 class="text-xs uppercase tracking-wide text-slate-400">Completion Tokens</h2>
        <p id="completionTokens" class="text-3xl font-semibold mt-2">--</p>
        <p class="text-xs text-slate-500 mt-1">Model output tokens streamed back.</p>
      </div>
      <div class="card p-5 shadow-lg">
        <h2 class="text-xs uppercase tracking-wide text-slate-400">Embedding Tokens</h2>
        <p id="embeddingTokens" class="text-3xl font-semibold mt-2">--</p>
        <p class="text-xs text-slate-500 mt-1">Token usage for KB search indexing.</p>
      </div>
    </section>

    <section class="grid gap-6 xl:grid-cols-3">
      <div class="card-soft p-6 shadow-lg xl:col-span-2">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold text-slate-200">Requests per Day</h2>
          <span class="text-xs text-slate-500">Last 60 days</span>
        </div>
        <div class="mt-4">
          <canvas id="requestsChart" height="220"></canvas>
        </div>
      </div>
      <div class="card-soft p-6 shadow-lg flex flex-col items-center justify-center gap-4">
        <h2 class="text-sm font-semibold text-slate-200">Average SSE Latency</h2>
        <div class="w-full flex flex-col items-center">
          <canvas id="sseGauge" height="200"></canvas>
          <div class="mt-3 text-center">
            <p class="text-2xl font-semibold" id="sseAverageText">--</p>
            <p class="text-xs text-slate-500">Samples tracked: <span id="sseSamples">0</span></p>
          </div>
        </div>
      </div>
    </section>

    <section class="card-soft p-6 shadow-lg">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold text-slate-200">Tokens Used</h2>
        <span class="text-xs text-slate-500">Prompt vs Completion vs Embedding</span>
      </div>
      <div class="mt-4">
        <canvas id="tokensChart" height="200"></canvas>
      </div>
    </section>

    <section class="grid gap-6 lg:grid-cols-3">
      <div class="card-soft p-6 shadow-lg lg:col-span-2 overflow-hidden">
        <h2 class="text-sm font-semibold text-slate-200">Top Routes</h2>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead class="text-xs uppercase text-slate-400">
              <tr class="text-left">
                <th class="py-2 pr-4">Route</th>
                <th class="py-2 pr-4">Requests</th>
              </tr>
            </thead>
            <tbody id="routes-body" class="divide-y divide-slate-800"></tbody>
          </table>
        </div>
      </div>
      <div class="card-soft p-6 shadow-lg overflow-hidden">
        <h2 class="text-sm font-semibold text-slate-200">KB Cache</h2>
        <div class="mt-4 space-y-2 text-sm">
          <div class="flex items-center justify-between"><span class="text-slate-400">Hits</span><span id="kbHits" class="font-semibold text-slate-200">0</span></div>
          <div class="flex items-center justify-between"><span class="text-slate-400">Misses</span><span id="kbMisses" class="font-semibold text-slate-200">0</span></div>
          <div class="flex items-center justify-between"><span class="text-slate-400">Hit Rate</span><span id="kbHitRate" class="font-semibold text-slate-200">0%</span></div>
        </div>
        <p class="text-xs text-slate-500 mt-4">KB search responses are cached for 5 minutes to accelerate repeat lookups.</p>
      </div>
    </section>

    <section class="grid gap-6 lg:grid-cols-2">
      <div class="card-soft p-6 shadow-lg overflow-hidden">
        <h2 class="text-sm font-semibold text-slate-200">Top Users</h2>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead class="text-xs uppercase text-slate-400">
              <tr class="text-left">
                <th class="py-2 pr-4">User</th>
                <th class="py-2 pr-4">Requests</th>
              </tr>
            </thead>
            <tbody id="users-body" class="divide-y divide-slate-800"></tbody>
          </table>
        </div>
      </div>
      <div class="card-soft p-6 shadow-lg">
        <h2 class="text-sm font-semibold text-slate-200">Recent API Activity</h2>
        <ul id="recent-list" class="mt-4 space-y-3 text-sm max-h-72 overflow-y-auto"></ul>
      </div>
    </section>

    <section class="card-soft p-6 shadow-lg">
      <h2 class="text-sm font-semibold text-slate-200">Event History</h2>
      <ul id="event-list" class="mt-4 space-y-3 text-sm max-h-72 overflow-y-auto"></ul>
    </section>
  </div>

  <script>
    const state = {
      key: localStorage.getItem('aidlexAdminKey') || '',
      charts: {},
      fetching: false
    };

    const statusEl = document.getElementById('status');
    const lastUpdatedEl = document.getElementById('last-updated');

    function formatNumber(val) {
      if (val === null || val === undefined) return '--';
      return Number(val).toLocaleString('en-US');
    }

    function formatMs(ms) {
      if (ms === null || ms === undefined) return '--';
      if (ms >= 1000) return `${(ms / 1000).toFixed(2)} s`;
      return `${Math.round(ms)} ms`;
    }

    function formatTimestamp(ts) {
      if (!ts) return '--';
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return '--';
      return d.toLocaleString();
    }

    function ensureKey(force = false) {
      if (state.key && !force) return state.key;
      const input = prompt('Enter ADMIN key to access analytics:');
      if (!input) {
        statusEl.textContent = 'Admin key is required to view analytics.';
        return null;
      }
      state.key = input.trim();
      localStorage.setItem('aidlexAdminKey', state.key);
      return state.key;
    }

    function initCharts() {
      if (state.charts.requests) return;
      const requestCtx = document.getElementById('requestsChart');
      state.charts.requests = new Chart(requestCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Requests',
            data: [],
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56,189,248,0.2)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: { color: '#cbd5f5' },
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#cbd5f5' },
              grid: { color: 'rgba(148,163,184,0.18)' }
            }
          },
          plugins: {
            legend: { labels: { color: '#e2e8f0' } }
          }
        }
      });

      const tokensCtx = document.getElementById('tokensChart');
      state.charts.tokens = new Chart(tokensCtx, {
        type: 'bar',
        data: {
          labels: ['Prompt', 'Completion', 'Embedding'],
          datasets: [{
            label: 'Tokens',
            data: [0, 0, 0],
            backgroundColor: ['#818cf8', '#f472b6', '#facc15']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#e2e8f0' } }
          },
          scales: {
            x: { ticks: { color: '#cbd5f5' }, grid: { display: false } },
            y: { beginAtZero: true, ticks: { color: '#cbd5f5' }, grid: { color: 'rgba(148,163,184,0.18)' } }
          }
        }
      });

      const sseCtx = document.getElementById('sseGauge');
      state.charts.sse = new Chart(sseCtx, {
        type: 'doughnut',
        data: {
          labels: ['Latency', 'Remaining'],
          datasets: [{
            data: [0, 1],
            backgroundColor: ['#f97316', '#1e293b'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          rotation: -90,
          circumference: 180,
          cutout: '65%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
    }

    function updateCharts(data) {
      const days = data.daily.slice(-60);
      const labels = days.map(d => d.date);
      const counts = days.map(d => d.count);
      state.charts.requests.data.labels = labels;
      state.charts.requests.data.datasets[0].data = counts;
      state.charts.requests.update();

      const tokens = [data.tokens.prompt || 0, data.tokens.completion || 0, data.tokens.embedding || 0];
      state.charts.tokens.data.datasets[0].data = tokens;
      state.charts.tokens.update();

      const avg = data.sse.averageMs || 0;
      const maxGauge = Math.max(1000, avg * 1.6, (data.sse.latestMs || 0) * 1.2);
      const latencyVal = Math.min(avg, maxGauge);
      state.charts.sse.data.datasets[0].data = [latencyVal, Math.max(maxGauge - latencyVal, 0.01)];
      state.charts.sse.update();
    }

    function renderTable(tbody, rows, keyField, valueField, limit = 8) {
      tbody.innerHTML = '';
      rows.slice(0, limit).forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-900/40 transition';
        const keyCell = document.createElement('td');
        keyCell.className = 'py-2 pr-4';
        keyCell.textContent = row[keyField];
        const valueCell = document.createElement('td');
        valueCell.className = 'py-2 pr-4 text-slate-200 font-medium';
        valueCell.textContent = formatNumber(row[valueField]);
        tr.appendChild(keyCell);
        tr.appendChild(valueCell);
        tbody.appendChild(tr);
      });
      if (!rows.length) {
        const emptyRow = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 2;
        cell.className = 'py-4 text-center text-slate-500';
        cell.textContent = 'No data yet';
        emptyRow.appendChild(cell);
        tbody.appendChild(emptyRow);
      }
    }

    function renderList(element, items, formatter, limit = 12) {
      element.innerHTML = '';
      if (!items.length) {
        const li = document.createElement('li');
        li.className = 'text-slate-500';
        li.textContent = 'No entries yet';
        element.appendChild(li);
        return;
      }
      items.slice(0, limit).forEach(item => {
        const li = document.createElement('li');
        li.className = 'border border-slate-800/80 rounded-lg p-3 bg-slate-900/60';
        li.textContent = formatter(item);
        element.appendChild(li);
      });
    }

    function updateUI(data) {
      statusEl.textContent = '';
      lastUpdatedEl.textContent = new Date(data.updatedAt).toLocaleTimeString();

      document.getElementById('totalRequests').textContent = formatNumber(data.totalRequests);
      document.getElementById('promptTokens').textContent = formatNumber(data.tokens.prompt);
      document.getElementById('completionTokens').textContent = formatNumber(data.tokens.completion);
      document.getElementById('embeddingTokens').textContent = formatNumber(data.tokens.embedding);

      document.getElementById('sseAverageText').textContent = formatMs(data.sse.averageMs);
      document.getElementById('sseSamples').textContent = formatNumber(data.sse.samples);

      const kb = data.cache?.kb || { hits: 0, misses: 0 };
      document.getElementById('kbHits').textContent = formatNumber(kb.hits || 0);
      document.getElementById('kbMisses').textContent = formatNumber(kb.misses || 0);
      const totalCache = (kb.hits || 0) + (kb.misses || 0);
      const hitRate = totalCache ? ((kb.hits || 0) / totalCache) * 100 : 0;
      document.getElementById('kbHitRate').textContent = `${hitRate.toFixed(1)}%`;

      renderTable(document.getElementById('routes-body'), data.routes, 'route', 'count');
      renderTable(document.getElementById('users-body'), data.users, 'user', 'count');

      renderList(
        document.getElementById('recent-list'),
        data.recent,
        item => `${formatTimestamp(item.ts)} • ${item.method} ${item.route} • ${item.user} • ${formatMs(item.duration)} (${item.status})`,
        12
      );

      renderList(
        document.getElementById('event-list'),
        data.events,
        item => `${formatTimestamp(item.ts)} • ${item.type} • ${item.summary}`,
        20
      );

      if (!state.charts.requests) {
        initCharts();
      }
      updateCharts(data);
    }

    async function fetchUsage(forcePrompt = false) {
      if (state.fetching) return;
      if (!state.key || forcePrompt) {
        const key = ensureKey(forcePrompt);
        if (!key) return;
      }
      state.fetching = true;
      try {
        const res = await fetch('/admin/usage', {
          headers: { 'x-admin-key': state.key },
          cache: 'no-store'
        });
        if (res.status === 403) {
          localStorage.removeItem('aidlexAdminKey');
          state.key = '';
          statusEl.textContent = 'Invalid admin key. Please try again.';
          ensureKey(true);
          return;
        }
        if (!res.ok) throw new Error(`Request failed: ${res.status}`);
        const data = await res.json();
        updateUI(data);
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Unable to refresh usage: ${err.message}`;
      } finally {
        state.fetching = false;
      }
    }

    fetchUsage(true);
    setInterval(() => fetchUsage(false), 10000);
  </script>
</body>
</html>
